/*
 * Corne Keymap v23
 * Layout: Colemak
 * Target: Android (Ctrl is primary, GUI is secondary)
 * Homerow mods: CASG (CTRL-RALT-SHIFT-GUI) - all Alts are RALT
 * Changes from v22: Layer 1 - BSPC/DEL na row 1, word-delete na row 2
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>

/ {
    behaviors {
        hm: homerow_mods {
            compatible = "zmk,behavior-hold-tap";
            #binding-cells = <2>;
            tapping-term-ms = <280>;
            quick-tap-ms = <175>;
            require-prior-idle-ms = <150>;
            flavor = "tap-preferred";
            bindings = <&kp>, <&kp>;
        };

        // ? default, / with shift
        qmark_slash: qmark_slash {
            compatible = "zmk,behavior-mod-morph";
            #binding-cells = <0>;
            bindings = <&kp QMARK>, <&kp FSLH>;
            mods = <(MOD_LSFT|MOD_RSFT)>;
        };

        // : default, ; with shift
        colon_semi: colon_semi {
            compatible = "zmk,behavior-mod-morph";
            #binding-cells = <0>;
            bindings = <&kp COLON>, <&kp SEMI>;
            mods = <(MOD_LSFT|MOD_RSFT)>;
        };
    };

    combos {
        compatible = "zmk,combos";

        // Utility combos from v20
        combo_backspace {
            timeout-ms = <50>;
            key-positions = <1 2>;    // Q + W
            bindings = <&kp BSPC>;
        };
        combo_enter {
            timeout-ms = <50>;
            key-positions = <8 9>;    // U + Y (positions in Colemak)
            bindings = <&kp RET>;
        };
        combo_delete {
            timeout-ms = <50>;
            key-positions = <20 14>;  // E + R (home row)
            bindings = <&kp DEL>;
        };
        combo_caps_lock {
            timeout-ms = <50>;
            key-positions = <5 6>;    // G + J (inner index)
            bindings = <&kp CAPS>;
        };
        combo_bootloader {
            timeout-ms = <50>;
            key-positions = <0 11>;   // Corner keys for safety
            bindings = <&bootloader>;
        };
        combo_caps_word {
            timeout-ms = <50>;
            key-positions = <16 19>;  // T + N (index fingers)
            bindings = <&caps_word>;
        };

        // Brackets - home row adjacent keys
        combo_lbrc {
            timeout-ms = <50>;
            key-positions = <13 14>;  // A + R
            bindings = <&kp LBRC>;
        };
        combo_lbkt {
            timeout-ms = <50>;
            key-positions = <14 15>;  // R + S
            bindings = <&kp LBKT>;
        };
        combo_lpar {
            timeout-ms = <50>;
            key-positions = <15 16>;  // S + T
            bindings = <&kp LPAR>;
        };
        combo_rpar {
            timeout-ms = <50>;
            key-positions = <19 20>;  // N + E
            bindings = <&kp RPAR>;
        };
        combo_rbkt {
            timeout-ms = <50>;
            key-positions = <20 21>;  // E + I
            bindings = <&kp RBKT>;
        };
        combo_rbrc {
            timeout-ms = <50>;
            key-positions = <21 22>;  // I + O
            bindings = <&kp RBRC>;
        };

        // Layer combos
        combo_layer5 {
            timeout-ms = <50>;
            key-positions = <25 26>;  // Z + X
            bindings = <&sl 5>;
        };
        combo_layer6 {
            timeout-ms = <50>;
            key-positions = <27 28>;  // C + V
            bindings = <&sl 6>;
        };
    };

    keymap {
        compatible = "zmk,keymap";

        // Layer 0: Base (Colemak)
        // Homerow mods: CASG = A=CTRL, R=RALT, S=SHIFT, T=GUI (mirrored on right)
        base_layer {
            display-name = "Base";
            bindings = <
   &none      &kp Q  &kp W  &kp F  &kp P  &kp G      &kp J  &kp L  &kp U      &kp Y    &colon_semi  &none
   &kp ESC    &hm LCTRL A  &hm RALT R  &hm LSHFT S  &hm LGUI T  &kp D      &kp H  &hm RGUI N  &hm RSHFT E  &hm RALT I  &hm RCTRL O  &kp GRAVE
   &kp RALT   &kp Z  &kp X  &kp C  &kp V  &kp B      &kp K  &kp M  &kp COMMA  &kp DOT  &qmark_slash  &kp RSHFT
                     &kp RALT  &kp SPACE  &lt 1 TAB  &lt 2 RET  &lt 5 BSPC  &kp RALT
            >;
        };

        // Layer 1: Numbers + Navigation
        // Navigation uses LG for word-jumping (Cmd on macOS)
        num_layer {
            display-name = "Num";
            bindings = <
   &none        &none       &none        &none         &none         &none       &kp LBKT   &kp N7  &kp N8  &kp N9  &kp RBKT   &trans
   &kp LC(BSPC) &kp UP      &kp LEFT     &kp RIGHT     &kp DOWN      &kp LC(DEL) &kp LPAR   &kp N4  &kp N5  &kp N6  &kp RPAR   &trans
   &kp BSPC     &kp HOME    &kp LC(LEFT) &kp LC(RIGHT) &kp END       &kp DEL     &kp LBRC   &kp N1  &kp N2  &kp N3  &kp RBRC   &trans
                                      &trans        &trans        &none       &kp N0     &kp MINUS  &kp N0
            >;
        };

        // Layer 2: Symbols
        sym_layer {
            display-name = "Sym";
            bindings = <
   &trans  &kp EQUAL  &kp PLUS   &kp LA(K)  &kp FSLH      &kp LS(SQT)   &none     &kp LS(N7)  &kp LS(N8)  &none      &none      &none
   &trans  &kp MINUS  &kp EXCL   &kp AT     &kp HASH      &kp SQT       &none     &kp LS(N4)  &kp LS(N5)  &kp LS(N6) &kp LA(B)  &trans
   &trans  &kp LS(MINUS) &kp LS(NUBS) &kp NUBS &kp BSLH  &kp LS(BSLH)  &none     &none       &none       &none      &none      &trans
                                 &trans     &trans        &trans        &trans    &trans      &trans
            >;
        };

        // Layer 3: Diacritics (accessed via right ALT thumb)
        // Sends LALT+key for macOS keylayout
        diacritics_layer {
            display-name = "Dia";
            bindings = <
   &trans  &kp LA(Q)  &kp LA(W)  &kp LA(F)  &kp LA(P)  &kp LA(G)      &kp LA(J)  &kp LA(L)  &kp LA(U)      &kp LA(Y)    &kp LA(SEMI)  &trans
   &trans  &kp LA(A)  &kp LA(R)  &kp LA(S)  &kp LA(T)  &kp LA(D)      &kp LA(H)  &kp LA(N)  &kp LA(E)      &kp LA(I)    &kp LA(O)     &trans
   &trans  &kp LA(Z)  &kp LA(X)  &kp LA(C)  &kp LA(V)  &kp LA(B)      &kp LA(K)  &kp LA(M)  &kp LA(COMMA)  &kp LA(DOT)  &kp LA(FSLH)  &trans
                                 &trans     &trans     &trans         &trans     &trans     &trans
            >;
        };

        // Layer 4: Function Keys + Media
        fn_layer {
            display-name = "Fn";
            bindings = <
   &kp K_MUTE  &kp K_VOL_DN  &kp K_VOL_UP  &kp K_PP    &kp K_NEXT  &kp K_PREV   &kp K_MUTE  &kp K_VOL_DN  &kp K_VOL_UP  &kp K_PP   &kp K_NEXT &trans
   &trans      &kp F17       &kp KP_ENTER  &kp F20     &kp K_FIND  &kp C_BRI_UP &kp F7      &kp F8        &kp F9        &kp F10    &kp F11    &trans
   &trans      &kp F13       &kp F14       &kp F15     &kp F16     &kp C_BRI_DN &kp F1      &kp F2        &kp F3        &kp F4     &kp F5     &trans
                                           &trans      &trans      &trans       &trans      &trans        &kp F6
            >;
        };

        // Layer 5: Bluetooth + Media (hold BSPC)
        // Left: Media | Right: BT profiles
        bt_layer {
            display-name = "BT";
            bindings = <
   &kp K_MUTE  &kp K_VOL_DN  &kp K_VOL_UP  &kp K_PP  &kp K_NEXT  &kp K_PREV   &bt BT_SEL 0  &bt BT_SEL 1   &bt BT_SEL 2   &bt BT_SEL 3   &bt BT_SEL 4   &bt BT_SEL 5
   &none       &none         &none         &none     &none       &none        &bt BT_DISC 0 &bt BT_DISC 1  &bt BT_DISC 2  &bt BT_DISC 3  &bt BT_DISC 4  &bt BT_DISC 5
   &none       &none         &none         &none     &none       &none        &none         &none          &none          &none          &none          &bt BT_CLR
                         &none  &none  &none      &none         &none          &none
            >;
        };

        // Layer 6: Dead Keys (C+V combo)
        deadkey_layer {
            display-name = "Dead";
            bindings = <
   &none   &none         &none         &none        &none        &none         &none        &none         &none         &none         &none         &none
   &none   &kp LA(N6)    &kp LA(N7)    &kp LA(N8)   &kp LA(N9)   &none         &none        &kp LA(N0)    &kp LA(MINUS) &kp LA(EQUAL) &none         &none
   &none   &none         &none         &none        &none        &none         &none        &none         &none         &none         &none         &none
                                       &none        &none        &none         &none        &none         &none
            >;
            // Home row: Macron(6) Circumflex(7) Umlaut(8) Caron(9) | Breve(0) Acute(-) Cedilla(=)
        };

        extra7 { status = "reserved"; };
        extra8 { status = "reserved"; };
        extra9 { status = "reserved"; };
    };
};

// Caps word configuration
&caps_word {
    continue-list = <UNDERSCORE MINUS BACKSPACE DELETE>;
};
